var gdjs;(function(n){const g=new n.Logger("Game manager"),c=l=>new Promise(e=>setTimeout(e,l)),h=l=>l.usedResources.map(e=>e.name);let u=null;const m=()=>{if(u)return u;u=[];try{new CompressionStream("gzip"),u.push("cs:gzip")}catch{}try{new CompressionStream("deflate"),u.push("cs:deflate")}catch{}return u},p=()=>{try{const e=new URL(location.href).searchParams.get("runtimeGameStatus");if(!e)return null;const t=JSON.parse(e);return{isPaused:!!t.isPaused,isInGameEdition:!!t.isInGameEdition,sceneName:""+t.sceneName,injectedExternalLayoutName:""+t.injectedExternalLayoutName,skipCreatingInstancesFromScene:!!t.skipCreatingInstancesFromScene,eventsBasedObjectType:t.eventsBasedObjectType,eventsBasedObjectVariantName:t.eventsBasedObjectVariantName,editorId:t.editorId,editorCamera3D:t.editorCamera3D}}catch{return null}};class _{constructor(e,t){this._sceneAndExtensionsData=[];this._displayedLoadingScreen=null;this._notifyScenesForGameResolutionResize=!1;this._paused=!1;this._hasJustResumed=!1;this._sessionMetricsInitialized=!1;this._disableMetrics=!1;this._wasDisposed=!1;this.getPlatformInfo=()=>({isCordova:!!window.cordova,devicePlatform:typeof device!="undefined"&&device.platform||"",navigatorPlatform:typeof navigator!="undefined"?navigator.platform:"",hasTouch:typeof navigator!="undefined"?!!navigator.maxTouchPoints&&navigator.maxTouchPoints>2:!1,supportedCompressionMethods:m()});if(this._options=t||{},this._isPreview=this._options.isPreview||!1,this._isPreview){const i=p();i&&(this._options.initialRuntimeGameStatus=i)}this._isInGameEdition=this._options.initialRuntimeGameStatus?.isInGameEdition||!1,this._variables=new n.VariablesContainer(e.variables),this._variablesByExtensionName=new Map;for(const i of e.eventsFunctionsExtensions)i.globalVariables.length>0&&this._variablesByExtensionName.set(i.name,new n.VariablesContainer(i.globalVariables));this._eventsBasedObjectDatas=new Map,this._data=e,this._updateSceneAndExtensionsData(),this._sceneResourcesPreloading=this._data.properties.sceneResourcesPreloading||"at-startup",this._sceneResourcesUnloading=this._data.properties.sceneResourcesUnloading||"never",this._resourcesLoader=new n.ResourceLoader(this,e.resources.resources,h(e),e.layouts),this._inGameEditor=this._isInGameEdition?new n.InGameEditor(this,e,this._options.inGameEditorSettings||null):null,this._debuggerClient=n.DebuggerClient?new n.DebuggerClient(this):null,this._effectsManager=new n.EffectsManager,this._maxFPS=this._data.properties.maxFPS,this._minFPS=this._data.properties.minFPS,this._gameResolutionWidth=this._data.properties.windowWidth,this._gameResolutionHeight=this._data.properties.windowHeight,this._originalWidth=this._gameResolutionWidth,this._originalHeight=this._gameResolutionHeight,this._resizeMode=this._data.properties.sizeOnStartupMode,this._adaptGameResolutionAtRuntime=this._data.properties.adaptGameResolutionAtRuntime,this._scaleMode=e.properties.scaleMode||"linear",this._pixelsRounding=this._data.properties.pixelsRounding,this._antialiasingMode=this._data.properties.antialiasingMode,this._isAntialisingEnabledOnMobile=this._data.properties.antialisingEnabledOnMobile,this._renderer=new n.RuntimeGameRenderer(this,this._options.forceFullscreen||!1),this._watermark=new n.watermark.RuntimeWatermark(this,e.properties.authorUsernames,this._data.properties.watermark),this._sceneStack=new n.SceneStack(this),this._inputManager=new n.InputManager,this._captureManager=n.CaptureManager?new n.CaptureManager(this._renderer,this._options.captureOptions||{}):null,this._sessionId=null,this._playerId=null,this._embeddedResourcesMappings=new Map;for(const i of this._data.resources.resources)if(i.metadata)try{const s=JSON.parse(i.metadata);s?.embeddedResourcesMapping&&this._embeddedResourcesMappings.set(i.name,s.embeddedResourcesMapping)}catch{g.error("Some metadata of resources can not be successfully parsed.")}this.isUsingGDevelopDevelopmentEnvironment()&&g.info("This game will run on the development version of GDevelop APIs.")}setProjectData(e){this._inGameEditor&&this._inGameEditor.onProjectDataChange(e),this._data=e,this._updateSceneAndExtensionsData(),this._resourcesLoader.setResources(e.resources.resources,h(e),e.layouts)}_updateSceneAndExtensionsData(){const e=this._data.eventsFunctionsExtensions.filter(t=>t.sceneVariables.length>0);if(this._sceneAndExtensionsData=this._data.layouts.map(t=>({sceneData:t,usedExtensionsWithVariablesData:e})),this._eventsBasedObjectDatas.clear(),this._data.eventsFunctionsExtensions)for(const t of this._data.eventsFunctionsExtensions)for(const i of t.eventsBasedObjects)this._eventsBasedObjectDatas.set(t.name+"::"+i.name,i)}getAdditionalOptions(){return this._options}getRenderer(){return this._renderer}getVariables(){return this._variables}getVariablesForExtension(e){return this._variablesByExtensionName.get(e)||null}getResourceLoader(){return this._resourcesLoader}getSoundManager(){return this._resourcesLoader.getSoundManager()}getImageManager(){return this._resourcesLoader.getImageManager()}getFontManager(){return this._resourcesLoader.getFontManager()}getBitmapFontManager(){return this._resourcesLoader.getBitmapFontManager()}getJsonManager(){return this._resourcesLoader.getJsonManager()}getModel3DManager(){return this._resourcesLoader.getModel3DManager()}getSpineManager(){return this._resourcesLoader.getSpineManager()}getSpineAtlasManager(){return this._resourcesLoader.getSpineAtlasManager()}getInputManager(){return this._inputManager}getEffectsManager(){return this._effectsManager}getGameData(){return this._data}getEventsBasedObjectData(e){const t=this._eventsBasedObjectDatas.get(e);return t||(g.error('The game has no events-based object of the type "'+e+'"'),null)}getEventsBasedObjectVariantData(e,t){const i=this.getEventsBasedObjectData(e);return i?n.RuntimeGame._getEventsBasedObjectVariantData(i,t):null}static _getEventsBasedObjectVariantData(e,t){if(e.defaultVariant||(e.defaultVariant={...e,name:""}),e.defaultVariant.instances.length==0)return e.defaultVariant;let s=e.defaultVariant;for(let a=0;a<e.variants.length;a++){const r=e.variants[a];r.name===t&&(s=r)}return s}getSceneAndExtensionsData(e){for(let t=0,i=this._sceneAndExtensionsData.length;t<i;++t){const s=this._sceneAndExtensionsData[t];if(e===void 0||s.sceneData.name===e)return s}return g.error('The game has no scene called "'+e+'"'),null}hasScene(e){for(let t=0,i=this._data.layouts.length;t<i;++t){const s=this._data.layouts[t];if(e===void 0||s.name==e)return!0}return!1}getSceneData(e){for(let t=0,i=this._data.layouts.length;t<i;++t){const s=this._data.layouts[t];if(s.name==e)return s}return null}getExternalLayoutData(e){let t=null;for(let i=0,s=this._data.externalLayouts.length;i<s;++i){const a=this._data.externalLayouts[i];if(a.name===e){t=a;break}}return t}getInitialObjectsData(){return this._data.objects||[]}getOriginalWidth(){return this._originalWidth}getOriginalHeight(){return this._originalHeight}getGameResolutionWidth(){return this._gameResolutionWidth}getGameResolutionHeight(){return this._gameResolutionHeight}setGameResolutionSize(e,t){if(this._throwIfDisposed(),this._gameResolutionWidth=e,this._gameResolutionHeight=t,(this._adaptGameResolutionAtRuntime||this._isInGameEdition)&&n.RuntimeGameRenderer&&n.RuntimeGameRenderer.getWindowInnerWidth&&n.RuntimeGameRenderer.getWindowInnerHeight){const i=n.RuntimeGameRenderer.getWindowInnerWidth(),s=n.RuntimeGameRenderer.getWindowInnerHeight();if(this._isInGameEdition)this._gameResolutionWidth=i,this._gameResolutionHeight=s;else if(this._resizeMode==="adaptWidth")this._gameResolutionWidth=this._gameResolutionHeight*i/s;else if(this._resizeMode==="adaptHeight")this._gameResolutionHeight=this._gameResolutionWidth*s/i;else if(this._resizeMode==="scaleOuter"){const a=i/this._originalWidth,r=s/this._originalHeight;a<r?(this._gameResolutionWidth=this._originalWidth,this._gameResolutionHeight=Math.floor(s/a)):(this._gameResolutionWidth=Math.floor(i/r),this._gameResolutionHeight=this._originalHeight)}}this._renderer.updateRendererSize(),this._notifyScenesForGameResolutionResize=!0}setGameResolutionResizeMode(e){this._resizeMode=e,this._forceGameResolutionUpdate()}getGameResolutionResizeMode(){return this._resizeMode}setAdaptGameResolutionAtRuntime(e){this._adaptGameResolutionAtRuntime=e,this._forceGameResolutionUpdate()}getAdaptGameResolutionAtRuntime(){return this._adaptGameResolutionAtRuntime}getMinimalFramerate(){return this._minFPS}getScaleMode(){return this._scaleMode}getPixelsRounding(){return this._pixelsRounding}getAntialiasingMode(){return this._antialiasingMode}isAntialisingEnabledOnMobile(){return this._isAntialisingEnabledOnMobile}pause(e){this._paused!==e&&(this._paused=e,this._inGameEditor&&this._inGameEditor.activate(e),this._debuggerClient&&this._debuggerClient.sendRuntimeGameStatus())}hasJustResumed(){return this._hasJustResumed}prioritizeLoadingOfScene(e){this._resourcesLoader.loadSceneResources(e)}getSceneLoadingProgress(e){return this._resourcesLoader.getSceneLoadingProgress(e)}areSceneAssetsLoaded(e){return this._resourcesLoader.areSceneAssetsLoaded(e)}areSceneAssetsReady(e){return this._resourcesLoader.areSceneAssetsReady(e)}getSceneResourcesPreloading(){return this._sceneResourcesPreloading}getSceneResourcesUnloading(){return this._sceneResourcesUnloading}loadAllAssets(e,t){this._throwIfDisposed(),this.loadFirstAssetsAndStartBackgroundLoading(this._getFirstSceneName(),t).then(e)}async loadFirstAssetsAndStartBackgroundLoading(e,t){try{const i=this._data.properties.loadingScreen.backgroundImageResourceName;i&&await this._resourcesLoader.getImageManager().loadResource(i),await Promise.all([this._loadAssetsWithLoadingScreen(!0,async s=>{await this._resourcesLoader.loadGlobalAndFirstSceneResources(e,s),this._resourcesLoader.loadAllSceneInBackground()},t),n.getAllAsynchronouslyLoadingLibraryPromise()])}catch(i){throw this._debuggerClient&&this._debuggerClient.onUncaughtException(i),i}}async loadSceneAssets(e,t){await this._loadAssetsWithLoadingScreen(!1,async i=>{await this._resourcesLoader.loadAndProcessSceneResources(e,i)},t)}async _loadAssetsWithLoadingScreen(e,t,i){this.pause(!0);const s=new n.LoadingScreenRenderer(this.getRenderer(),this._resourcesLoader.getImageManager(),this._data.properties.loadingScreen,this._data.properties.watermark.showWatermark,e);this._displayedLoadingScreen=s,await t(async(r,o)=>{const d=Math.floor(100*r/o);s.setPercent(d),i&&i(d),s.renderIfNeeded()&&await c(1)}),await s.unload(),this._displayedLoadingScreen=null,this._isInGameEdition||this.pause(!1)}_getFirstSceneName(){const e=this._options.initialRuntimeGameStatus?.sceneName||this._data.firstLayout;return this.hasScene(e)?e:this.getSceneAndExtensionsData().sceneData.name}startGameLoop(){this._throwIfDisposed();try{if(!this.hasScene()){g.error("The game has no scene.");return}this._forceGameResolutionUpdate();const e=this._getFirstSceneName(),t=this._options.initialRuntimeGameStatus?.injectedExternalLayoutName||null;if(this._inGameEditor){const a=this._options.initialRuntimeGameStatus?.eventsBasedObjectType||null,r=this._options.initialRuntimeGameStatus?.eventsBasedObjectVariantName||null,o=this._options.initialRuntimeGameStatus?.editorId||null,d=this._options.initialRuntimeGameStatus?.editorCamera3D||null;this._inGameEditor.switchToSceneOrVariant(o,e,t,a,r,d)}else e&&this.getSceneStack().replace({sceneName:e,externalLayoutName:t===null?void 0:t,clear:!0});this._watermark.displayAtStartup(),this._setupGameVisibilityEvents(),n.inAppTutorialMessage&&n.inAppTutorialMessage.displayInAppTutorialMessage(this,this._options.inAppTutorialMessageInPreview,this._options.inAppTutorialMessagePositionInPreview||"");let i=null,s=0;this._hasJustResumed=!1,this._renderer.startGameLoop(a=>{try{if(this._debuggerClient){const o=(this._inGameEditor||this.getSceneStack()).getCurrentScene();o&&o.getName()!==i&&(i=o.getName(),this._debuggerClient.sendRuntimeGameStatus())}if(this._paused&&this._inGameEditor&&this._inGameEditor.updateTargetFramerate(a),s+=a,this._maxFPS>0&&1e3/s>this._maxFPS+7)return!0;const r=s;if(s=0,this._notifyScenesForGameResolutionResize&&(this._inGameEditor?this._inGameEditor.onGameResolutionResized():this._sceneStack.onGameResolutionResized(),this._notifyScenesForGameResolutionResize=!1),this._paused)this._inGameEditor?this._displayedLoadingScreen||this._inGameEditor.updateAndRender():this._sceneStack.renderWithoutStep();else{if(!this._sceneStack.step(r))return!1;this._hasJustResumed=!1}return this.getInputManager().onFrameEnded(),!0}catch(r){throw this._debuggerClient&&this._debuggerClient.onUncaughtException(r),r}}),setTimeout(()=>{this._setupSessionMetrics()},4e3),this._captureManager&&this._captureManager.setupCaptureOptions(this._isPreview)}catch(e){throw this._debuggerClient&&this._debuggerClient.onUncaughtException(e),e}}dispose(e){this._inGameEditor&&this._inGameEditor.dispose(),this._renderer.stopGameLoop(),this._sceneStack.dispose(),this._renderer.dispose(e),this._resourcesLoader.dispose(),this._wasDisposed=!0}enableMetrics(e){this._disableMetrics=!e,e&&this._setupSessionMetrics()}_setupGameVisibilityEvents(){typeof navigator!="undefined"&&typeof document!="undefined"&&(document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(this._hasJustResumed=!0)}),window.addEventListener("resume",()=>{this._hasJustResumed=!0},!1))}_setupSessionMetrics(){if(this._sessionMetricsInitialized||this._disableMetrics||this.isPreview()||typeof fetch=="undefined"||!this._data.properties.projectUuid)return;const e="https://api.gdevelop-app.com/analytics";this._playerId=this._makePlayerUuid();let t=0,i=0,s=Date.now();const a=this.getPlatformInfo();fetch(e+"/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gameId:this._data.properties.projectUuid,playerId:this._playerId,game:{name:this._data.properties.name||"",packageName:this._data.properties.packageName||"",version:this._data.properties.version||"",location:window.location.href},platform:{isCordova:a.isCordova,devicePlatform:a.devicePlatform,navigatorPlatform:a.navigatorPlatform,hasTouch:a.hasTouch}})}).then(o=>{if(!o.ok)throw console.error("Error while creating the session",o),new Error("Error while creating the session");return o}).then(o=>o.text()).then(o=>{this._sessionId=o}).catch(()=>{});const r=()=>{if(!this._sessionId)return;const o=Date.now();if(i+=o-s,s=o,i<5*1e3)return;const d=Math.floor(i/1e3)*1e3;t+=d,i-=d,navigator.sendBeacon(e+"/session-hit",JSON.stringify({gameId:this._data.properties.projectUuid,playerId:this._playerId,sessionId:this._sessionId,duration:Math.floor(t/1e3)}))};if(typeof navigator!="undefined"&&typeof document!="undefined"){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?s=Date.now():r()}),window.addEventListener("pagehide",r,!1),window.addEventListener("pause",r,!1),window.addEventListener("resume",()=>{s=Date.now()},!1);const o=typeof safari=="object"&&safari.pushNotification,d=/electron/i.test(navigator.userAgent);(o||d)&&window.addEventListener("beforeunload",()=>{r()})}this._sessionMetricsInitialized=!0,this._sessionId=this._sessionId}_makePlayerUuid(){try{const e="GDJS-internal-player-uuid",t=localStorage.getItem(e);if(t)return t;const i=n.makeUuid();return localStorage.setItem(e,i),i}catch{return n.makeUuid()}}getSessionId(){return this._sessionId}getPlayerId(){return this._playerId}onWindowInnerSizeChanged(){this._forceGameResolutionUpdate()}_forceGameResolutionUpdate(){this.setGameResolutionSize(this._gameResolutionWidth,this._gameResolutionHeight)}startCurrentSceneProfiler(e){this._throwIfDisposed();const t=this._sceneStack.getCurrentScene();return t?(t.startProfiler(e),!0):!1}stopCurrentSceneProfiler(){this._throwIfDisposed();const e=this._sceneStack.getCurrentScene();!e||e.stopProfiler()}wasFirstSceneLoaded(){return this._sceneStack.wasFirstSceneLoaded()}getSceneStack(){return this._sceneStack}isPreview(){return this._isPreview}isPaused(){return this._paused}isInGameEdition(){return this._isInGameEdition}getInGameEditor(){return this._inGameEditor}isBehaviorActivatedByDefaultInEditor(e){return this._data.activatedByDefaultInEditorBehaviors?this._data.activatedByDefaultInEditorBehaviors.includes(e):!1}setMaximumFps(e){this._maxFPS=e}isUsingGDevelopDevelopmentEnvironment(){return this._options.environment==="dev"}getExtensionProperty(e,t){for(let i of this._data.properties.extensionProperties)if(i.extension===e&&i.property===t)return i.value;return null}resolveEmbeddedResource(e,t){const i=this._embeddedResourcesMappings.get(e);return i&&i[t]?i[t]:t}getEmbeddedResourcesNames(e){return this._embeddedResourcesMappings.has(e)?Object.keys(this._embeddedResourcesMappings.get(e)):[]}getNetworkSyncData(e){const t={var:e.syncGameVariables===!1?void 0:this._variables.getNetworkSyncData(e),sm:e.syncSounds?this.getSoundManager().getNetworkSyncData():void 0,ss:this._sceneStack.getNetworkSyncData(e)||void 0};if(e.syncGameVariables!==!1){const i={};this._variablesByExtensionName.forEach((s,a)=>{const r=s.getNetworkSyncData(e);r.length&&(i[a]=r)}),t.extVar=i}return(!t.var||t.var.length===0)&&!t.ss&&(!t.extVar||Object.keys(t.extVar).length===0)?null:t}updateFromNetworkSyncData(e,t){if(this._throwIfDisposed(),e.var&&this._variables.updateFromNetworkSyncData(e.var,t),e.sm&&this.getSoundManager().updateFromNetworkSyncData(e.sm),e.ss&&this._sceneStack.updateFromNetworkSyncData(e.ss),e.extVar)for(const i in e.extVar){if(!e.extVar.hasOwnProperty(i))continue;const s=e.extVar[i],a=this.getVariablesForExtension(i);a&&a.updateFromNetworkSyncData(s,t)}}_throwIfDisposed(){if(this._wasDisposed)throw"The RuntimeGame has been disposed and should not be used anymore."}}n.RuntimeGame=_})(gdjs||(gdjs={}));
//# sourceMappingURL=runtimegame.js.map
